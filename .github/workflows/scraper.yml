# .github/workflows/scraper.yml  (ou o nome que estiver usando)

name: Scraping IPHAN Notícias
on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
    # 1) clone completo
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0            # necessário p/ rebase e push

    # 2) Node.js
    - uses: actions/setup-node@v4
      with:
        node-version: 20

    # 3) dependências
    - name: Instalar dependências
      run: npm install --no-audit --no-fund

    # 4) rodar o scraper
    - name: Rodar script de scraping
      env:
        NODE_TLS_REJECT_UNAUTHORIZED: "0"
      run: node scripts/scraper-iphan.js

    # 5) commit + push (pull --rebase + push --force-with-lease)
    - name: Commit e enviar alterações se existirem
      uses: EndBug/add-and-commit@v9
      with:
        add:                'noticias_iphan.json'
        default_author:     github_actions
        message:            'chore: atualizar noticias_iphan.json'
        pull:               '--rebase'             # puxa e rebate
        push:               '--force-with-lease'   # força só se remoto não mudou
